import puppeteer from "puppeteer";
import fs from 'fs'
import fetch from "node-fetch";

const katas = [
  "55f3da49e83ca1ddae0000ad",
  "5592e3bd57b64d00f3000047",
  "559a28007caad2ac4e000083",
  "559ce00b70041bc7b600013d",
  "55aa075506463dac6600010d",
  "566fc12495810954b1000030",
  "61123a6f2446320021db987d",
  "5f0ed36164f2bc00283aed07",
  "58712dfa5c538b6fc7000569",
  "56606694ec01347ce800001b",
  "52774a314c2333f0a7000688",
  "55ab4f980f2d576c070000f4",
  "55b3425df71c1201a800009c",
  "58ce8725c835848ad6000007",
  "56c5847f27be2c3db20009c3",
  "5550d638a99ddb113e0000a2",
  "534ea96ebb17181947000ada",
  "542c0f198e077084c0000c2e",
  "55b4d87a3766d9873a0000d4",
  "55e2adece53b4cdcb900006c",
  "566543703c72200f0b0000c9",
  "559b8e46fa060b2c6a0000bf",
  "566be96bb3174e155300001b",
  "5672682212c8ecf83e000050",
  "57040e445a726387a1001cf7",
  "570409d3d80ec699af001bf9",
  "5518a860a73e708c0a000027",
  "5a3fe3dde1ce0e8ed6000097",
  "5a90c9ecb171012b47000077",
  "555624b601231dc7a400017a",
  "55fd2d567d94ac3bc9000064",
  "550498447451fbbd7600041c",
  "569b5cec755dd3534d00000f",
  "5a023c426975981341000014",
  "5b853229cfde412a470000d0",
  "5933a1f8552bc2750a0000ed",
  "56b7771481290cc283000f28",
  "55f9bca8ecaa9eac7100004a",
  "55f73be6e12baaa5900000d4",
  "5545f109004975ea66000086",
  "53ee5429ba190077850011d4",
  "523b66342d0c301ae400003b",
  "55685cd7ad70877c23000102",
  "5a057ec846d843c81a0000ad",
  "541c8630095125aba6000c00",
  "563a631f7cbbc236cf0000c2",
  "5ae62fcf252e66d44d00008e",
  "53da3dbb4a5168369a0000fe",
  "56dec885c54a926dcd001095",
  "582cb0224e56e068d800003c",
  "563f0c54a22b9345bf000053",
  "523b4ff7adca849afe000035",
  "55d24f55d7dd296eb9000030",
  "56c04261c3fcf33f2d000534",
  "546d5028ddbcbd4b8d001254",
  "50654ddff44f800200000004",
  "556deca17c58da83c00002db",
  "57a049e253ba33ac5e000212",
  "5574835e3e404a0bed00001b",
  "58184387d14fc32f2b0012b2",
  "526571aae218b8ee490006f4",
  "50ee6b0bdeab583673000025",
  "56a5d994ac971f1ac500003e",
  "52597aa56021e91c93000cb0",
  "5ce969ab07d4b7002dcaa7a1",
  "56efab15740d301ab40002ee",
  "561e9c843a2ef5a40c0000a4",
  "5613d06cee1e7da6d5000055",
  "5556282156230d0e5e000089",
  "5b06c990908b7eea73000069",
  "57a0e5c372292dd76d000d7e",
  "5b1cd19fcd206af728000056",
  "5168bb5dfe9a00b126000018",
  "54ff3102c1bad923760001f3",
  "56bc28ad5bdaeb48760009b0",
  "5264d2b162488dc400000001",
  "59ccf051dcc4050f7800008f",
  "55a2d7ebe362935a210000b2",
  "5b180e9fedaa564a7000009a",
  "55a70521798b14d4750000a4",
  "59c5f4e9d751df43cf000035",
  "53369039d7ab3ac506000467",
  "59c633e7dcc4053512000073",
  "55e7280b40e1c4a06d0000aa",
  "5ce6728c939bf80029988b57",
  "59d9ff9f7905dfeed50000b0",
  "54edbc7200b811e956000556",
  "554b4ac871d6813a03000035",
  "57cebe1dc6fdc20c57000ac9",
  "5a00e05cc374cb34d100000d",
  "51c8991dee245d7ddf00000e",
  "525f50e3b73515a6db000b83",
  "54b42f9314d9229fd6000d9c",
  "5656b6906de340bd1b0000ac",
  "57eadb7ecd143f4c9c0000a3",
  "585a033e3a36cdc50a00011c",
  "5715eaedb436cf5606000381",
  "514b92a657cdc65150000006",
  "57f781872e3d8ca2a000007e",
  "56a73d2194505c29f600002d",
  "54da5a58ea159efa38000836",
  "5b0c0ec907756ffcff00006e",
  "5d50e3914861a500121e1958",
  "5a4d303f880385399b000001",
  "58acfe4ae0201e1708000075",
  "59a8570b570190d313000037",
  "5c6d80d7ff00de2dcc4d4188",
  "57a1fd2ce298a731b20006a4",
  "5a2fd38b55519ed98f0000ce",
  "5848565e273af816fb000449",
  "5a045fee46d843effa000070",
  "5a48948e145c46820b00002f",
  "538835ae443aae6e03000547",
  "577c349edf78c178a1000108",
  "5726f813c8dcebf5ed000a6b",
  "5390bac347d09b7da40006f6",
  "581ee0db1bbdd04e010002fd",
  "5b40b666dfb4291ad9000049",
  "5552101f47fc5178b1000050",
  "57a0556c7cb1f31ab3000ad7",
  "51ba717bb08c1cd60f00002f",
  "573182c405d14db0da00064e",
  "5700c9acc1555755be00027e",
  "515f51d438015969f7000013",
  "586d6cefbcc21eed7a001155",
  "559e3224324a2b6e66000046",
  "51f2d1cafc9c0f745c00037d",
  "54d7660d2daf68c619000d95",
  "54dc6f5a224c26032800005c",
  "57eb8fcdf670e99d9b000272",
  "57cfdf34902f6ba3d300001e",
  "54d512e62a5e54c96200019e",
  "54db15b003e88a6a480000b9",
  "54de3257f565801d96001200",
  "54e320dcebe1e583250008fd",
  "54f8693ea58bce689100065f",
  "55031bba8cba40ada90011c4",
  "5506b230a11c0aeab3000c1f",
  "5517fcb0236c8826940003c9",
  "5539fecef69c483c5a000015",
  "55225023e1be1ec8bc000390",
  "5aa736a455f906981800360d",
  "56efc695740d30f963000557",
  "5174a4c0f2769dd8b1000003",
  "5259b20d6021e9e14c0010d4",
  "585a1a227cb58d8d740001c3",
  "5b39e3772ae7545f650000fc",
  "576bb71bbbcf0951d5000044",
  "5544c7a5cb454edb3c000047",
  "55466989aeecab5aac00003e",
  "54bf1c2cd5b56cc47f0007a1",
  "5547cc7dcad755e480000004",
  "554a44516729e4d80b000012",
  "554f76dca89983cc400000bb",
  "55be10de92aad5ef28000023",
  "5ce9c1000bab0b001134f5af",
  "55c6126177c9441a570000cc",
  "5a34b80155519e1a00000009",
  "6108f2fa3e38e900070b818c",
  "5541f58a944b85ce6d00006a",
  "54b724efac3d5402db00065e",
  "55e6f5e58f7817808e00002e",
  "51fc12de24a9d8cb0e000001",
  "57eae20f5500ad98e50002c5",
  "562e274ceca15ca6e70000d3",
  "562f91ff6a8b77dfe900006e",
  "56347fcfd086de8f11000014",
  "563b662a59afc2b5120000c6",
  "564057bc348c7200bd0000ff",
  "56445c4755d0e45b8c00010a",
  "515decfd9dcfc23bb6000006",
  "5852d0d463adbd39670000a1",
  "56484848ba95170a8000004d",
  "56541980fa08ab47a0000040",
  "5d65fbdfb96e1800282b5ee0",
  "565abd876ed46506d600000d",
  "565c0fa6e3a7d39dee000125",
  "5ef9ca8b76be6d001d5e1c3e",
  "5663f5305102699bad000056",
  "56f3a1e899b386da78000732",
  "598f76a44f613e0e0b000026",
  "56ed20a2c4e5d69155000301",
  "56f253dd75e340ff670002ac",
  "5667e8f4e3f572a8f2000039",
  "56e3cd1d93c3d940e50006a4",
  "56fcc393c5957c666900024d",
  "56dbf59b0a10feb08c000227",
  "56dbeec613c2f63be4000be6",
  "554e4a2f232cdd87d9000038",
  "56dbe7f113c2f63570000b86",
  "56dbe0e313c2f63be4000b25",
  "5772382d509c65de7e000982",
  "550554fd08b86f84fe000a58",
  "54d496788776e49e6b00052f",
  "550f22f4d758534c1100025a",
  "5a420163b6cfd7cde5000077",
  "56af1a20509ce5b9b000001e",
  "515e271a311df0350d00000f",
  "56b5afb4ed1f6d5fb0000991",
  "56baeae7022c16dd7400086e",
  "56cac350145912e68b0006f0",
  "56fe17fcc25bf3e19a000292",
  "57591ef494aba64d14000526",
  "59c68ea2aeb2843e18000109",
  "59d0ee709f0cbcf65400003b",
  "59d727d40e8c9dd2dd00009f",
  "59d9d8cb27ee005972000045",
  "59f4a0acbee84576800000af",
  "56e7d40129035aed6c000632",
  "57aa218e72292d98d500240f",
  "573992c724fc289553000e95",
  "550527b108b86f700000073f",
  "559536379512a64472000053",
  "5536a85b6ed4ee5a78000035",
  "56a32dd6e4f4748cc3000006",
  "5863f97fb3a675d9a700003f",
  "523a86aa4230ebb5420001e1",
  "59de1e2fe50813a046000124",
  "55cf3b567fc0e02b0b00000b",
  "5ba38ba180824a86850000f7",
  "5616868c81a0f281e500005c",
  "59f44c7bd4b36946fd000052",
  "59df2f8f08c6cec835000012",
  "56a4872cbb65f3a610000026",
  "58841cb52a077503c4000015",
  "567501aec64b81e252000003",
  "5629db57620258aa9d000014",
  "5a6b24d4e626c59d5b000066",
  "569218bc919ccba77000000b",
  "56f6919a6b88de18ff000b36",
  "56f695399400f5d9ef000af5",
  "5868b2de442e3fb2bb000119",
  "553e8b195b853c6db4000048",
  "54eb33e5bc1a25440d000891",
  "51b6249c4612257ac0000005",
  "534d2f5b5371ecf8d2000a08",
  "586538146b56991861000293",
  "59ca8246d751df55cc00014c",
  "55cbd4ba903825f7970000f5",
  "517abf86da9663f1d2000003",
  "52f677797c461daaf7000740",
  "55983863da40caa2c900004e",
  "57f780909f7e8e3183000078",
  "57d165ad95497ea150000020",
  "56f6ad906b88de513f000d96",
  "59d7c910f703c460a2000034",
  "59706036f6e5d1e22d000016",
  "585d7d5adb20cf33cb000235",
  "562b384167350ac93b00010c",
  "5a71939d373c2e634200008e",
  "59f08f89a5e129c543000069",
  "5ecc1d68c6029000017d8aaf",
  "5a3357ae8058425bde002674",
  "5a092d9e46d843b9db000064",
  "5dd259444228280032b1ed2a",
  "51e0007c1f9378fa810002a9",
  "521c2db8ddc89b9b7a0000c1",
  "5aba780a6a176b029800041c",
  "5d26721d48430e0016914faa",
  "515de9ae9dcfc28eb6000001",
  "5d653190d94b3b0021ec8f2b",
  "5976c5a5cd933a7bbd000029",
  "56eb0be52caf798c630013c0",
  "58678d29dbca9a68d80000d7",
  "5bd776533a7e2720c40000e5",
  "5a662a02e626c54e87000123",
  "5a24254fe1ce0ec2eb000078",
  "58e24788e24ddee28e000053",
  "5a29a0898f27f2d9c9000058",
  "59e66e48fc3c499ec5000103",
  "5b6b67a5ecd0979e5b00000e",
  "5efae11e2d12df00331f91a6",
  "5279f6fe5ab7f447890006a7",
  "56eb16655250549e4b0013f4",
  "5a8cacb2d5261f53ec0031f3",
  "5f55ecd770692e001484af7d",
  "57fd696e26b06857eb0011e7",
  "5b5fe164b88263ad3d00250b",
  "511f11d355fe575d2c000001",
  "598d91785d4ce3ec4f000018",
  "5edc8c53d7cede0032eb6029",
  "5917a2205ffc30ec3a0000a8",
  "58008f9897917feeec000a3e",
  "5e0b72d2d772160011133654",
  "5d81d8571c6411001a40ba66",
  "5a24a35a837545ab04001614",
  "5d617c2fa5e6a2001a369da2",
  "58f5c63f1e26ecda7e000029",
  "5811aef3acdf4dab5e000251",
  "54b72c16cd7f5154e9000457",
  "52249faee9abb9cefa0001ee",
  "54521e9ec8e60bc4de000d6c",
  "54207f9677730acd490000d1",
  "5a941f3a4a6b34edf900006f",
  "5b162ed4c8c47ea2f5000023",
  "5a8d1c82373c2e099d0000ac",
  "5aa39ba75084d7cf45000008",
  "5b83c1c44a6acac33400009a",
  "59f38b033640ce9fc700015b",
  "59ce11ea9f0cbc8a390000ed",
  "57a6633153ba33189e000074",
  "5b752a42b11814b09c00005d",
  "599b1a4a3c5292b4cc0000d5",
  "5526fc09a1bbd946250002dc",
  "5dd5128f16eced000e4c42ba",
  "59cfc09a86a6fdf6df0000f1",
  "55a29405bc7d2efaff00007c",
  "59cfc000aeb2844d16000075",
  "5ac94db76bde60383d000038",
  "515e188a311df01cba000003",
  "5946a0a64a2c5b596500019a",
  "56bdd0aec5dc03d7780010a5",
  "5886e082a836a691340000c3",
  "5bb904724c47249b10000131",
  "58c5577d61aefcf3ff000081",
  "56cd44e1aa4ac7879200010b",
  "56b7f2f3f18876033f000307",
  "5508249a98b3234f420000fb",
  "584daf7215ac503d5a0001ae",
  "56d931ecc443d475d5000003",
  "58941fec8afa3618c9000184",
  "587136ba2eefcb92a9000027",
  "588422ba4e8efb583d00007d",
  "56fa3c5ce4d45d2a52001b3c",
  "5a03b3f6a1c9040084001765",
  "55cbc3586671f6aa070000fb",
  "5c466083a4db1e0f49ddcb30",
  "5deeb1cc0d5bc9000f70aa74",
  "5da995d583326300293ce4cb",
  "5671d975d81d6c1c87000022",
  "56f69d9f9400f508fb000ba7",
  "5af4119888214326b4000019",
  "59f98052120be4abfa000304",
  "587d7544f1be39c48c000109",
  "536a155256eb459b8700077e",
  "5b4070144d7d8bbfe7000001",
  "5d2659626c7aec0022cb8006",
  "5879f95892074d769f000272",
  "55084d3898b323f0aa000546",
  "55e86e212fce2aae75000060",
  "58845748bd5733f1b300001f",
  "54b679eaac3d54e6ca0008c9",
  "57be674b93687de78c0001d9",
  "565f5825379664a26b00007c",
  "5495bfa82eced2146100002f",
  "5bb804397274c772b40000ca",
  "587731fda577b3d1b0001196",
  "5821cd4770ca285b1f0001d5",
  "588417e576933b0ec9000045",
  "526dbd6c8c0eb53254000110",
  "5420fc9bb5b2c7fd57000004",
  "586c1cf4b98de0399300001d",
  "5827e2efc983ca6f230000e0",
  "544975fc18f47481ba00107b",
  "58af1bb7ac7e31b192000020",
  "59342039eb450e39970000a6",
  "5d6eef37f257f8001c886d97",
  "52c31f8e6605bcc646000082",
  "5d339b01496f8d001054887f",
  "58b22dc7a5d5def60300002a",
  "5bbdee6acd4ec8ca520001e0",
  "583f158ea20cfcbeb400000a",
  "5b077ebdaf15be5c7f000077",
  "5d076515e102162ac0dc514e",
  "52b757663a95b11b3d00062d",
  "5679d5a3f2272011d700000d",
  "5277c8a221e209d3f6000b56",
  "5cd12646cf44af0020c727dd",
  "58485a43d750d23bad0000e6",
  "5869848f2d52095be20001d1",
  "54cb771c9b30e8b5250011d4",
  "58a3a735cebc0630830000c0",
  "52bc74d4ac05d0945d00054e",
  "529bf0e9bdf7657179000008",
  "54de279df565808f8b00126a",
  "5695995cc26a1e90fe00004d",
  "5861487fdb20cff3ab000030",
  "5928da5f1fad49c34d00013a",
  "589631d24a7323d18d00016f",
  "5af4855c68e6449fbf00015c",
  "589273272fab865136000108",
  "586dd26a69b6fd46dd0000c0",
  "59cd39a7a25c8c117d00020c",
  "5868a68ba44cfc763e00008d",
  "59727ff285281a44e3000011",
  "58989a079c70093f3e00008d",
  "5926624c9b424d10390000bf",
  "57339a5226196a7f90001bcf",
  "5269452810342858ec000951",
  "58a57c6bcebc069d7e0001fe",
  "52756e5ad454534f220001ef",
  "57d0089e05c186ccb600035e",
  "57f6ad55cca6e045d2000627"
]

function saveImageToDisk(url, filename) {
  fetch(url)
    .then(res => {
      const dest = fs.createWriteStream(filename);
      res.body.pipe(dest)
    })
    .catch((err) => {
      console.log(err)
    })
}

(async () => {
  const host = 'https://www.codewars.com/kata/'
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  for (const kata of katas) {
    console.log(`scrapping: ${host+kata}`);
    await page.goto(host+kata);
    await page.waitForTimeout(2000);

    let {title, body, images, points} = await page.evaluate(() => {
      let points = document.querySelectorAll('main .inner-small-hex span')[0].innerText
      let title = document.querySelectorAll('.w-full h4.ml-4')[0].innerText.replaceAll("/", "-slash-").replaceAll(".", "").replaceAll("\n", "").trim()
      let images = []
      Array.from(document.querySelectorAll('#description img')).map(img => {
        let src = img.src
        let srcArray = src.split('/')
        let pos = srcArray.length - 1
        let filename = srcArray[pos]
        images.push({
          src,
          filename
        })
      })
      let body = document.querySelectorAll('#description')[0].innerHTML.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, function (match) {
        return match.replace(/<img([^>]*)\ssrc=(['"])(?:[^\2\/]*\/)*([^\2]+)\2/gi, "<img$1 src=$2images/$3$2");
      }).trim();

      return {title, images, body, points}
    })

    let text = `<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>${title}</title>
    <link rel="stylesheet" media="screen" href="css/style.css">
</head>
<body>
    <div id="app">
        <div class="w-full" id="shell">
            <main id="shell_content">
                <div class="w-full mt-2">
                    <h2>${title}</h2>
                    <h2>Points: ${points}</h2>
                    <a href="${host+kata}"><h2>Kata ID: ${kata}</h2></a>
                    <div class="w-full panel bg-ui-section">
                        <div class="markdown prose max-w-5xl mx-auto" id="description">
                            ${body}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html>
`

    images.map((image) => {
      let filename = `./problems/codewars/images/${image.filename}`
      saveImageToDisk(image.src, filename)
    })
    fs.writeFileSync(`problems/codewars/${title}.html`, text);
  }

  await browser.close();
})();
